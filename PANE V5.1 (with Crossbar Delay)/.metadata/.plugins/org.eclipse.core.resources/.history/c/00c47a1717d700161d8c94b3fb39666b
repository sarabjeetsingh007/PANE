/*
 * source.cc
 *
 *  Created on: Aug 3, 2016
 *      Author: sarab
 */
#include<string.h>
#include<stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include<omnetpp.h>
#include "packets_m.h"
using namespace omnetpp;

//char c_timer;
//FILE *fp_timer;
//int fromlen_timer;
///*register*/ int s_timer, ns_timer, len_timer;
//struct sockaddr_un saun_timer, fsaun_timer;
//fd_set readset_timer;
//struct timeval tv_timer;
////char myvariable_timer[50];

//char const *str_tbs_timer = "From Controller!\n";

//int count = 0;
//char c_src;
//FILE *fp_src[4];
//int fromlen_src;
///*register*/ int s_src[4], ns_src[4], len_src;
//struct sockaddr_un saun_src[4], fsaun_src[4];
//char myvariable_src[50];
//
//char const *str_tbs_src = "From Omi!\n";

class mod_src : public cSimpleModule
{
    private:
       bool ack;
       Packet *somemsg;
       SimTime current_time;
    public:
       mod_src();
       virtual ~mod_src();
    protected:
//       virtual void generateMessage();
        virtual void initialize() override;
//        void timer();
        void init_socket();
        virtual void handleMessage(cMessage *msg) override;
        virtual void finish() override;
};

Define_Module(mod_src);

mod_src::mod_src()
{
    ack=true;
}

mod_src::~mod_src()
{//..
}

void mod_src::initialize()
{
//    static bool wasExecuted_source = false;
//     if (wasExecuted_source)
//     {
//    //             return;
//     }
//     else
//     {
//         wasExecuted_source = true;
//         init_socket();
//         timer();
//     }
}
void mod_src::handleMessage(cMessage *msg)
{
    if(msg->arrivedOn("Ack_in"))
    {
//        timer();
//        EV<<"~~~~~~~~~~~~~~~~~~~~~~~~~ SOURCE["<<this->getIndex()<<"]: Received, Acknowledgement\n";//, ID: "<<ttmsg->getPid()<<" \n";
        sendDelayed(msg,0.0,"out_controller");
    }
    else if(msg->arrivedOn("in_controller"))
    {
        somemsg = check_and_cast<Packet *>(msg);
//        EV<<"~~~~~~~~~~~~~~~~~~~~~~~~~ SOURCE["<<this->getIndex()<<"]: Received, Message, ID: "<<somemsg->getPid()<<" \n";
        sendDelayed(somemsg,0.0/*(double)(intuniform(0,10)/100.0)*/,"out");
//        delete ttmsg;
    }
    else if(msg->arrivedOn("timeout_in"))
    {
        sendDelayed(check_and_cast<Star *>(msg),0.0/*(double)(intuniform(0,10)/100.0)*/,"timeout_out");
    }
}
void mod_src::finish()
{
//       EV<<"FINISH:\nNumber of packets generated = "<<count<<"\n";
}




